<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday - Work Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #0073ea;
            --primary-hover: #0060b9;
            --primary-selected: #cce5ff;
            --success: #00c875;
            --success-hover: #00a25b;
            --warning: #fdab3d;
            --danger: #e2445c;
            --purple: #a25ddc;
            --dark-blue: #0086c0;
            --pink: #ff158a;
            --sky: #579bfc;
            --grass: #037f4c;
            --dark: #323338;
            --gray-dark: #676879;
            --gray: #c5c7d0;
            --gray-light: #e6e9ef;
            --bg: #f6f7fb;
            --white: #ffffff;
            --sidebar-bg: #292f4c;
            --sidebar-hover: #4b4e69;
            --row-hover: #f5f6f8;
            --border: #e6e9ef;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Figtree', 'Noto Sans Arabic', sans-serif;
            background: var(--bg);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
        }

        body[dir="rtl"] { font-family: 'Noto Sans Arabic', 'Figtree', sans-serif; }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: 250px;
            min-width: 250px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, #ff642e, #ff007a);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo svg { width: 20px; height: 20px; fill: white; }

        .brand-name {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-search {
            margin: 8px 12px;
            position: relative;
        }

        .sidebar-search input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .sidebar-search input::placeholder { color: rgba(255,255,255,0.5); }
        .sidebar-search input:focus { background: rgba(255,255,255,0.15); }

        .sidebar-search svg {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            fill: rgba(255,255,255,0.5);
        }

        .sidebar-nav {
            padding: 8px 0;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
        }

        .nav-item:hover { background: var(--sidebar-hover); color: white; }
        .nav-item.active { background: var(--primary); color: white; }

        .nav-item svg { width: 20px; height: 20px; fill: currentColor; opacity: 0.8; }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 12px 16px;
        }

        .nav-section-title {
            padding: 12px 20px 8px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .workspace-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 14px;
        }

        .workspace-item:hover { background: var(--sidebar-hover); }

        .ws-color {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .board-list { padding: 0 8px; }

        .board-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            color: rgba(255,255,255,0.75);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
        }

        .board-item:hover { background: var(--sidebar-hover); color: white; }
        .board-item.active { background: rgba(0,115,234,0.3); color: white; }

        .board-item svg { width: 18px; height: 18px; fill: currentColor; }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--white);
        }

        /* Top Header */
        .top-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--white);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .board-title-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .board-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .board-title-dropdown {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: var(--gray-dark);
        }

        .board-title-dropdown:hover { background: var(--gray-light); }

        .star-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            color: var(--gray);
        }

        .star-btn:hover { color: var(--warning); background: var(--gray-light); }
        .star-btn svg { width: 18px; height: 18px; fill: currentColor; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--white);
            border: 1px solid var(--gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--dark);
            transition: all 0.15s;
        }

        .header-btn:hover { background: var(--gray-light); }
        .header-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .header-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .header-btn.primary:hover { background: var(--primary-hover); }

        .header-btn.monday {
            background: #ff3d57;
            border-color: #ff3d57;
            color: white;
        }

        .header-btn.monday:hover { background: #e63650; }

        .avatar-group {
            display: flex;
            margin-right: 8px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            margin-right: -8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        /* Tabs Bar */
        .tabs-bar {
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            background: var(--white);
        }

        .tab {
            padding: 14px 16px;
            font-size: 14px;
            color: var(--gray-dark);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab:hover { color: var(--dark); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 500; }
        .tab svg { width: 16px; height: 16px; fill: currentColor; }

        .tab-add {
            padding: 8px;
            color: var(--gray-dark);
            cursor: pointer;
        }

        .tab-add:hover { color: var(--dark); }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--white);
        }

        .new-item-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-item-btn:hover { background: var(--primary-hover); }
        .new-item-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 12px;
            background: var(--white);
            border: 1px solid var(--gray);
            border-radius: 6px;
            min-width: 200px;
        }

        .search-box svg { width: 16px; height: 16px; fill: var(--gray-dark); }

        .search-box input {
            border: none;
            outline: none;
            font-size: 14px;
            width: 100%;
            background: transparent;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--white);
            border: 1px solid var(--gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--dark);
        }

        .toolbar-btn:hover { background: var(--gray-light); }
        .toolbar-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* ==================== BOARD ==================== */
        .board-container {
            flex: 1;
            overflow: auto;
            padding: 0 24px 24px;
        }

        .group {
            margin-bottom: 24px;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }

        .group-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }

        .group-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .group-toggle svg { width: 12px; height: 12px; fill: var(--gray-dark); }
        .group-toggle.open { transform: rotate(90deg); }

        .group-color {
            width: 6px;
            height: 32px;
            border-radius: 3px;
            margin-left: 12px;
        }

        .group-info { flex: 1; margin-right: 12px; }

        .group-name {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-count {
            font-size: 12px;
            color: var(--gray-dark);
            font-weight: 400;
        }

        .group-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .group-header:hover .group-actions { opacity: 1; }

        .group-actions button {
            padding: 6px;
            background: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--gray-dark);
        }

        .group-actions button:hover { background: var(--gray-light); }
        .group-actions button svg { width: 16px; height: 16px; fill: currentColor; }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
        }

        .table-header {
            display: grid;
            grid-template-columns: 40px 40px minmax(300px, 1fr) 140px 140px 120px 140px 50px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-dark);
            position: sticky;
            top: 0;
        }

        .table-header > div {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            border-left: 1px solid var(--border);
        }

        .table-header > div:first-child { border-left: none; }

        .col-resize {
            cursor: col-resize;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .task-row {
            display: grid;
            grid-template-columns: 40px 40px minmax(300px, 1fr) 140px 140px 120px 140px 50px;
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }

        .task-row:hover { background: var(--row-hover); }

        .task-row > div {
            padding: 0 12px;
            display: flex;
            align-items: center;
            min-height: 40px;
            border-left: 1px solid var(--border);
        }

        .task-row > div:first-child { border-left: none; }

        .cell-checkbox {
            justify-content: center;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            border: 1.5px solid var(--gray);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .checkbox:hover { border-color: var(--primary); }
        .checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .checkbox.checked svg { display: block; }
        .checkbox svg { width: 12px; height: 12px; fill: white; display: none; }

        .cell-expand {
            justify-content: center;
        }

        .expand-btn {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.15s;
        }

        .expand-btn:hover { background: var(--gray-light); color: var(--dark); }
        .expand-btn svg { width: 12px; height: 12px; fill: currentColor; }

        .cell-name {
            font-size: 14px;
            color: var(--dark);
            cursor: pointer;
            padding-right: 16px !important;
        }

        .task-name:hover { color: var(--primary); }

        .cell-person {
            justify-content: center;
        }

        .person-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        .person-avatar.empty {
            background: transparent;
            border: 2px dashed var(--gray);
            color: var(--gray);
            font-size: 14px;
        }

        .person-avatar.empty:hover { border-color: var(--primary); color: var(--primary); }

        .cell-status {
            justify-content: center;
            padding: 0 !important;
        }

        .status-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: filter 0.15s;
        }

        .status-cell:hover { filter: brightness(0.9); }

        .status-done { background: var(--success); }
        .status-working { background: var(--warning); }
        .status-stuck { background: var(--danger); }
        .status-pending { background: var(--gray); }
        .status-review { background: var(--purple); }

        .cell-date {
            justify-content: center;
            font-size: 13px;
            color: var(--dark);
        }

        .date-value {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .date-value:hover { background: var(--gray-light); }
        .date-value.overdue { color: var(--danger); font-weight: 500; }

        .cell-menu {
            justify-content: center;
        }

        .row-menu-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--gray);
            opacity: 0;
            transition: all 0.15s;
        }

        .task-row:hover .row-menu-btn { opacity: 1; }
        .row-menu-btn:hover { background: var(--gray-light); color: var(--dark); }
        .row-menu-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* Add Item Row */
        .add-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            color: var(--gray-dark);
            cursor: pointer;
            font-size: 14px;
            border-top: 1px solid var(--border);
        }

        .add-item-row:hover { color: var(--primary); background: var(--row-hover); }
        .add-item-row svg { width: 16px; height: 16px; fill: currentColor; }

        /* Add Group Button */
        .add-group-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            color: var(--gray-dark);
            cursor: pointer;
            font-size: 14px;
            border: 2px dashed var(--gray);
            border-radius: 8px;
            background: var(--white);
            margin-top: 8px;
            transition: all 0.15s;
        }

        .add-group-btn:hover { color: var(--primary); border-color: var(--primary); }
        .add-group-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--white);
            border-radius: 12px;
            width: 480px;
            max-width: 90%;
            box-shadow: var(--shadow);
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 { font-size: 18px; font-weight: 600; }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: var(--gray-dark);
        }

        .modal-close:hover { background: var(--gray-light); }
        .modal-close svg { width: 20px; height: 20px; fill: currentColor; }

        .modal-body { padding: 24px; }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray);
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s;
        }

        .form-group input:focus,
        .form-group select:focus { border-color: var(--primary); }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-secondary {
            background: var(--white);
            border: 1px solid var(--gray);
            color: var(--dark);
        }

        .btn-secondary:hover { background: var(--gray-light); }

        .btn-primary {
            background: var(--primary);
            border: 1px solid var(--primary);
            color: white;
        }

        .btn-primary:hover { background: var(--primary-hover); }

        /* Status Dropdown */
        .status-dropdown {
            position: fixed;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1001;
            display: none;
            min-width: 140px;
        }

        .status-dropdown.show { display: block; }

        .status-option {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: white;
            margin-bottom: 4px;
            text-align: center;
            transition: filter 0.15s;
        }

        .status-option:last-child { margin-bottom: 0; }
        .status-option:hover { filter: brightness(0.9); }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 1001;
            display: none;
            min-width: 200px;
        }

        .context-menu.show { display: block; }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--dark);
            transition: background 0.1s;
        }

        .menu-item:hover { background: var(--gray-light); }
        .menu-item.danger { color: var(--danger); }
        .menu-item svg { width: 16px; height: 16px; fill: currentColor; }

        .menu-divider { height: 1px; background: var(--border); margin: 8px 0; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1002;
            transition: transform 0.3s;
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast svg { width: 18px; height: 18px; fill: var(--success); }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1003;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 16px;
            font-size: 16px;
            color: var(--gray-dark);
        }

        .hidden { display: none !important; }

        /* Language Toggle */
        .lang-toggle {
            display: flex;
            background: var(--gray-light);
            border-radius: 6px;
            padding: 3px;
        }

        .lang-btn {
            padding: 6px 12px;
            border: none;
            background: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-dark);
            transition: all 0.15s;
        }

        .lang-btn.active {
            background: var(--white);
            color: var(--dark);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body dir="rtl">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">جاري التحميل...</div>
    </div>

    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <span id="toastText">تم الحفظ</span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                </div>
                <span class="brand-name">Sunday</span>
            </div>

            <div class="sidebar-search">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" placeholder="بحث..." id="sidebarSearch">
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active">
                    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    <span data-i18n="home">الرئيسية</span>
                </div>
                <div class="nav-item">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span data-i18n="myWork">مهامي</span>
                </div>
                <div class="nav-item">
                    <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    <span data-i18n="favorites">المفضلة</span>
                </div>

                <div class="nav-divider"></div>

                <div class="nav-section-title" data-i18n="workspaces">مساحات العمل</div>

                <div class="board-list" id="boardList">
                    <!-- Boards will be rendered here -->
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <div class="board-title-section">
                        <h1 class="board-title" id="currentBoardTitle">اسم البورد</h1>
                        <button class="board-title-dropdown">
                            <svg width="12" height="12" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z" fill="currentColor"/></svg>
                        </button>
                    </div>
                    <button class="star-btn">
                        <svg viewBox="0 0 24 24"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>
                    </button>
                </div>

                <div class="header-right">
                    <div class="lang-toggle">
                        <button class="lang-btn" onclick="setLang('en')">EN</button>
                        <button class="lang-btn active" onclick="setLang('ar')">عربي</button>
                    </div>

                    <button class="header-btn monday" onclick="syncFromMonday()">
                        <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0020 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 004 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z" fill="currentColor"/></svg>
                        Monday.com
                    </button>

                    <div class="avatar-group">
                        <div class="avatar" style="background:#0073ea">م</div>
                        <div class="avatar" style="background:#00c875">أ</div>
                    </div>

                    <button class="header-btn primary">
                        <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/></svg>
                        <span data-i18n="invite">دعوة</span>
                    </button>
                </div>
            </header>

            <div class="tabs-bar">
                <div class="tab active">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" fill="currentColor"/></svg>
                    <span data-i18n="mainTable">الجدول الرئيسي</span>
                </div>
                <div class="tab">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h-2l3-4 3 4h-2v8z" fill="currentColor"/></svg>
                    <span>Kanban</span>
                </div>
                <div class="tab">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" fill="currentColor"/></svg>
                    <span>Chart</span>
                </div>
                <div class="tab-add">+</div>
            </div>

            <div class="toolbar">
                <button class="new-item-btn" onclick="openNewItemModal()">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/></svg>
                    <span data-i18n="newItem">عنصر جديد</span>
                </button>

                <div class="search-box">
                    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" placeholder="بحث..." id="searchInput" oninput="filterTasks()">
                </div>

                <button class="toolbar-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/></svg>
                    <span data-i18n="person">شخص</span>
                </button>

                <button class="toolbar-btn">
                    <svg viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" fill="currentColor"/></svg>
                    <span data-i18n="filter">فلترة</span>
                </button>

                <button class="toolbar-btn">
                    <svg viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z" fill="currentColor"/></svg>
                    <span data-i18n="sort">ترتيب</span>
                </button>
            </div>

            <div class="board-container" id="boardContainer">
                <!-- Groups will be rendered here -->
            </div>
        </main>
    </div>

    <!-- New Item Modal -->
    <div class="modal-overlay" id="newItemModal">
        <div class="modal">
            <div class="modal-header">
                <h3 data-i18n="newItem">عنصر جديد</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="itemName">اسم العنصر</label>
                    <input type="text" id="newItemName" placeholder="أدخل اسم العنصر">
                </div>
                <div class="form-group">
                    <label data-i18n="group">المجموعة</label>
                    <select id="newItemGroup"></select>
                </div>
                <div class="form-group">
                    <label data-i18n="status">الحالة</label>
                    <select id="newItemStatus">
                        <option value="pending">معلق</option>
                        <option value="working">قيد العمل</option>
                        <option value="done">مكتمل</option>
                        <option value="stuck">متوقف</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">إلغاء</button>
                <button class="btn btn-primary" onclick="createNewItem()" data-i18n="create">إنشاء</button>
            </div>
        </div>
    </div>

    <!-- Status Dropdown -->
    <div class="status-dropdown" id="statusDropdown">
        <div class="status-option status-done" onclick="setStatus('done')">مكتمل</div>
        <div class="status-option status-working" onclick="setStatus('working')">قيد العمل</div>
        <div class="status-option status-stuck" onclick="setStatus('stuck')">متوقف</div>
        <div class="status-option status-pending" onclick="setStatus('pending')">معلق</div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="menu-item" onclick="openItem()">
            <svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z" fill="currentColor"/></svg>
            <span>فتح</span>
        </div>
        <div class="menu-item" onclick="duplicateItem()">
            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/></svg>
            <span>تكرار</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item danger" onclick="deleteItem()">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/></svg>
            <span>حذف</span>
        </div>
    </div>

    <!-- Board Selector Modal -->
    <div class="modal-overlay" id="boardSelector">
        <div class="modal" style="max-height:80vh;overflow:auto">
            <div class="modal-header">
                <h3>اختر بورد من Monday.com</h3>
                <button class="modal-close" onclick="closeBoardSelector()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/></svg>
                </button>
            </div>
            <div class="modal-body" id="boardSelectorList" style="padding:0">
                <!-- Monday boards will be listed here -->
            </div>
        </div>
    </div>

    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyACk3UhHouKfGsOu3ZJfaOhqLqucumn2UQ",
            authDomain: "sunday-fb28c.firebaseapp.com",
            databaseURL: "https://sunday-fb28c-default-rtdb.firebaseio.com",
            projectId: "sunday-fb28c",
            storageBucket: "sunday-fb28c.firebasestorage.app",
            messagingSenderId: "24752239756",
            appId: "1:24752239756:web:386c2c72624eb67ba337a9"
        };

        let database, firebaseReady = false;

        function initFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseReady = true;
                console.log('✅ Firebase ready');
                return true;
            } catch (e) {
                console.error('Firebase error:', e);
                return false;
            }
        }

        // ============ MONDAY.COM API ============
        const MONDAY_API = {
            url: 'https://api.monday.com/v2',
            token: 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjQ5ODI0MTQ1NywiYWFpIjoxMSwidWlkIjo2NjU3MTg3OCwiaWFkIjoiMjAyNS0wNC0xMFQxMjowMTowOS4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6MjU0ODI1MzEsInJnbiI6ImV1YzEifQ.i9ZMOxFuUPb2XySVeUsZbE6p9vGy2REefTmwSekf24I'
        };

        async function mondayQuery(query, variables = {}) {
            try {
                const res = await fetch(MONDAY_API.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': MONDAY_API.token,
                        'API-Version': '2024-01'
                    },
                    body: JSON.stringify({ query, variables })
                });
                const data = await res.json();
                return data.data;
            } catch (e) {
                console.error('Monday API error:', e);
                return null;
            }
        }

        async function getMondayBoards() {
            const query = `query { boards(limit: 50) { id name groups { id title color } } }`;
            const data = await mondayQuery(query);
            return data?.boards || [];
        }

        async function getMondayBoardItems(boardId) {
            const query = `query($id: [ID!]) { boards(ids: $id) { groups { id title color items_page(limit: 100) { items { id name created_at column_values { id text type } subitems { id name } } } } } }`;
            const data = await mondayQuery(query, { id: [boardId] });
            return data?.boards?.[0]?.groups || [];
        }

        function convertMondayData(groups) {
            return groups.map((g, i) => ({
                id: parseInt(g.id) || Date.now() + i,
                title: g.title,
                color: g.color || '#0073ea',
                expanded: true,
                items: (g.items_page?.items || []).map(item => {
                    const cols = item.column_values || [];
                    const statusCol = cols.find(c => c.type === 'status' || c.id.includes('status'));
                    let status = 'pending';
                    if (statusCol?.text) {
                        const t = statusCol.text.toLowerCase();
                        if (t.includes('done') || t.includes('مكتمل')) status = 'done';
                        else if (t.includes('working') || t.includes('قيد')) status = 'working';
                        else if (t.includes('stuck') || t.includes('متوقف')) status = 'stuck';
                    }
                    return {
                        id: parseInt(item.id) || Date.now(),
                        name: item.name,
                        person: null,
                        status,
                        date: item.created_at?.split('T')[0] || new Date().toISOString().split('T')[0],
                        subitems: (item.subitems || []).map(s => ({
                            id: parseInt(s.id),
                            name: s.name,
                            status: 'pending'
                        }))
                    };
                })
            }));
        }

        let mondayBoards = [];

        async function syncFromMonday() {
            showLoading('جاري جلب البيانات من Monday.com...');
            mondayBoards = await getMondayBoards();
            hideLoading();
            if (mondayBoards.length > 0) {
                showBoardSelector();
            } else {
                showToast('لم يتم العثور على بوردات');
            }
        }

        function showBoardSelector() {
            const list = document.getElementById('boardSelectorList');
            list.innerHTML = mondayBoards.map(b => `
                <div onclick="loadMondayBoard('${b.id}')" style="padding:16px 24px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:12px;transition:background 0.15s">
                    <div style="width:40px;height:40px;background:var(--primary);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:16px">${b.name[0]}</div>
                    <div>
                        <div style="font-weight:600;font-size:15px">${b.name}</div>
                        <div style="font-size:13px;color:var(--gray-dark)">${b.groups?.length || 0} مجموعات</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('boardSelector').classList.add('show');
        }

        function closeBoardSelector() {
            document.getElementById('boardSelector').classList.remove('show');
        }

        async function loadMondayBoard(boardId) {
            closeBoardSelector();
            showLoading('جاري تحميل البورد...');
            const groups = await getMondayBoardItems(boardId);
            data.groups = convertMondayData(groups);
            hideLoading();
            renderBoard();
            autoSave();
            showToast('تم تحميل البورد بنجاح');
        }

        // ============ DATA ============
        let data = {
            groups: [
                {
                    id: 1,
                    title: 'مهام هذا الأسبوع',
                    color: '#0073ea',
                    expanded: true,
                    items: [
                        { id: 1, name: 'تصميم واجهة المستخدم', person: { name: 'أحمد', color: '#0073ea' }, status: 'done', date: '2025-01-20', subitems: [] },
                        { id: 2, name: 'تطوير API', person: { name: 'محمد', color: '#00c875' }, status: 'working', date: '2025-01-22', subitems: [] },
                        { id: 3, name: 'اختبار النظام', person: null, status: 'pending', date: '2025-01-25', subitems: [] }
                    ]
                },
                {
                    id: 2,
                    title: 'مهام قادمة',
                    color: '#00c875',
                    expanded: true,
                    items: [
                        { id: 4, name: 'إعداد الوثائق', person: { name: 'سارة', color: '#a25ddc' }, status: 'pending', date: '2025-01-28', subitems: [] },
                        { id: 5, name: 'نشر التطبيق', person: null, status: 'stuck', date: '2025-01-30', subitems: [] }
                    ]
                }
            ]
        };

        let selectedItem = null, selectedGroup = null;
        let currentLang = 'ar';

        // ============ TRANSLATIONS ============
        const translations = {
            ar: {
                home: 'الرئيسية', myWork: 'مهامي', favorites: 'المفضلة', workspaces: 'مساحات العمل',
                mainTable: 'الجدول الرئيسي', newItem: 'عنصر جديد', person: 'شخص', filter: 'فلترة',
                sort: 'ترتيب', invite: 'دعوة', itemName: 'اسم العنصر', group: 'المجموعة',
                status: 'الحالة', cancel: 'إلغاء', create: 'إنشاء', task: 'المهمة',
                owner: 'المسؤول', dueDate: 'التاريخ', addItem: '+ إضافة عنصر', addGroup: '+ إضافة مجموعة',
                items: 'عناصر', done: 'مكتمل', working: 'قيد العمل', stuck: 'متوقف', pending: 'معلق'
            },
            en: {
                home: 'Home', myWork: 'My Work', favorites: 'Favorites', workspaces: 'Workspaces',
                mainTable: 'Main Table', newItem: 'New Item', person: 'Person', filter: 'Filter',
                sort: 'Sort', invite: 'Invite', itemName: 'Item Name', group: 'Group',
                status: 'Status', cancel: 'Cancel', create: 'Create', task: 'Task',
                owner: 'Owner', dueDate: 'Due Date', addItem: '+ Add Item', addGroup: '+ Add Group',
                items: 'items', done: 'Done', working: 'Working', stuck: 'Stuck', pending: 'Pending'
            }
        };

        function t(key) { return translations[currentLang][key] || key; }

        function setLang(lang) {
            currentLang = lang;
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(lang === 'ar' ? 'عربي' : 'EN'));
            });
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            renderBoard();
        }

        // ============ RENDER ============
        function renderBoard() {
            const container = document.getElementById('boardContainer');
            const statusText = { done: t('done'), working: t('working'), stuck: t('stuck'), pending: t('pending') };

            container.innerHTML = data.groups.map(g => `
                <div class="group" data-group-id="${g.id}">
                    <div class="group-header" onclick="toggleGroup(${g.id})">
                        <div class="group-toggle ${g.expanded ? 'open' : ''}">
                            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"/></svg>
                        </div>
                        <div class="group-color" style="background:${g.color}"></div>
                        <div class="group-info">
                            <div class="group-name" style="color:${g.color}">
                                ${g.title}
                                <span class="group-count">${g.items.length} ${t('items')}</span>
                            </div>
                        </div>
                        <div class="group-actions">
                            <button onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="currentColor"/></svg></button>
                        </div>
                    </div>
                    ${g.expanded ? `
                        <div class="table-wrapper">
                            <div class="table-header">
                                <div></div>
                                <div></div>
                                <div>${t('task')}</div>
                                <div>${t('owner')}</div>
                                <div>${t('status')}</div>
                                <div>${t('dueDate')}</div>
                                <div></div>
                                <div></div>
                            </div>
                            ${g.items.map(item => renderTaskRow(item, g.id, statusText)).join('')}
                        </div>
                        <div class="add-item-row" onclick="addItemToGroup(${g.id})">
                            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/></svg>
                            ${t('addItem')}
                        </div>
                    ` : ''}
                </div>
            `).join('') + `
                <button class="add-group-btn" onclick="addNewGroup()">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/></svg>
                    ${t('addGroup')}
                </button>
            `;
        }

        function renderTaskRow(item, groupId, statusText) {
            const isOverdue = new Date(item.date) < new Date() && item.status !== 'done';
            return `
                <div class="task-row" data-item-id="${item.id}">
                    <div class="cell-checkbox">
                        <div class="checkbox ${item.status === 'done' ? 'checked' : ''}" onclick="toggleCheck(${groupId}, ${item.id})">
                            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/></svg>
                        </div>
                    </div>
                    <div class="cell-expand">
                        ${item.subitems?.length ? `
                            <button class="expand-btn" onclick="toggleSubitems(${groupId}, ${item.id})">
                                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"/></svg>
                            </button>
                        ` : ''}
                    </div>
                    <div class="cell-name">
                        <span class="task-name" onclick="openItemPanel(${groupId}, ${item.id})">${item.name}</span>
                    </div>
                    <div class="cell-person">
                        ${item.person ? `
                            <div class="person-avatar" style="background:${item.person.color}">${item.person.name[0]}</div>
                        ` : `
                            <div class="person-avatar empty">+</div>
                        `}
                    </div>
                    <div class="cell-status">
                        <div class="status-cell status-${item.status}" onclick="openStatusDropdown(event, ${groupId}, ${item.id})">
                            ${statusText[item.status]}
                        </div>
                    </div>
                    <div class="cell-date">
                        <span class="date-value ${isOverdue ? 'overdue' : ''}">${formatDate(item.date)}</span>
                    </div>
                    <div class="cell-date">
                        <span class="date-value">${formatDate(item.date)}</span>
                    </div>
                    <div class="cell-menu">
                        <button class="row-menu-btn" onclick="openContextMenu(event, ${groupId}, ${item.id})">
                            <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function formatDate(d) {
            return new Date(d).toLocaleDateString(currentLang === 'ar' ? 'ar-SA' : 'en-US', { day: 'numeric', month: 'short' });
        }

        // ============ ACTIONS ============
        function toggleGroup(id) {
            const g = data.groups.find(g => g.id === id);
            if (g) { g.expanded = !g.expanded; renderBoard(); autoSave(); }
        }

        function toggleCheck(gid, iid) {
            const g = data.groups.find(g => g.id === gid);
            const item = g?.items.find(i => i.id === iid);
            if (item) {
                item.status = item.status === 'done' ? 'pending' : 'done';
                renderBoard();
                autoSave();
            }
        }

        function openStatusDropdown(e, gid, iid) {
            e.stopPropagation();
            selectedGroup = data.groups.find(g => g.id === gid);
            selectedItem = selectedGroup?.items.find(i => i.id === iid);
            const dd = document.getElementById('statusDropdown');
            dd.style.top = e.clientY + 'px';
            dd.style.left = e.clientX + 'px';
            dd.classList.add('show');
        }

        function setStatus(status) {
            if (selectedItem) {
                selectedItem.status = status;
                renderBoard();
                autoSave();
            }
            document.getElementById('statusDropdown').classList.remove('show');
        }

        function openContextMenu(e, gid, iid) {
            e.stopPropagation();
            selectedGroup = data.groups.find(g => g.id === gid);
            selectedItem = selectedGroup?.items.find(i => i.id === iid);
            const menu = document.getElementById('contextMenu');
            menu.style.top = e.clientY + 'px';
            menu.style.left = e.clientX + 'px';
            menu.classList.add('show');
        }

        function deleteItem() {
            if (selectedItem && selectedGroup) {
                selectedGroup.items = selectedGroup.items.filter(i => i.id !== selectedItem.id);
                renderBoard();
                autoSave();
            }
            document.getElementById('contextMenu').classList.remove('show');
        }

        function duplicateItem() {
            if (selectedItem && selectedGroup) {
                const copy = JSON.parse(JSON.stringify(selectedItem));
                copy.id = Date.now();
                copy.name += ' (نسخة)';
                selectedGroup.items.push(copy);
                renderBoard();
                autoSave();
            }
            document.getElementById('contextMenu').classList.remove('show');
        }

        function openItem() {
            document.getElementById('contextMenu').classList.remove('show');
            // Could open detail panel
        }

        function addItemToGroup(gid) {
            const g = data.groups.find(g => g.id === gid);
            if (g) {
                g.items.push({
                    id: Date.now(),
                    name: 'عنصر جديد',
                    person: null,
                    status: 'pending',
                    date: new Date().toISOString().split('T')[0],
                    subitems: []
                });
                renderBoard();
                autoSave();
            }
        }

        function addNewGroup() {
            const colors = ['#0073ea', '#00c875', '#fdab3d', '#e2445c', '#a25ddc', '#0086c0'];
            data.groups.push({
                id: Date.now(),
                title: 'مجموعة جديدة',
                color: colors[Math.floor(Math.random() * colors.length)],
                expanded: true,
                items: []
            });
            renderBoard();
            autoSave();
        }

        function openNewItemModal() {
            const select = document.getElementById('newItemGroup');
            select.innerHTML = data.groups.map(g => `<option value="${g.id}">${g.title}</option>`).join('');
            document.getElementById('newItemModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('newItemModal').classList.remove('show');
        }

        function createNewItem() {
            const name = document.getElementById('newItemName').value.trim();
            const gid = parseInt(document.getElementById('newItemGroup').value);
            const status = document.getElementById('newItemStatus').value;

            if (name) {
                const g = data.groups.find(g => g.id === gid);
                if (g) {
                    g.items.push({
                        id: Date.now(),
                        name,
                        person: null,
                        status,
                        date: new Date().toISOString().split('T')[0],
                        subitems: []
                    });
                    renderBoard();
                    autoSave();
                    closeModal();
                    document.getElementById('newItemName').value = '';
                }
            }
        }

        function openItemPanel(gid, iid) {
            // For now just log
            console.log('Open item:', gid, iid);
        }

        function toggleSubitems(gid, iid) {
            console.log('Toggle subitems:', gid, iid);
        }

        function filterTasks() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.task-row').forEach(row => {
                const name = row.querySelector('.task-name')?.textContent.toLowerCase() || '';
                row.style.display = name.includes(q) ? '' : 'none';
            });
        }

        // Close dropdowns on click outside
        document.addEventListener('click', () => {
            document.getElementById('statusDropdown').classList.remove('show');
            document.getElementById('contextMenu').classList.remove('show');
        });

        // ============ FIREBASE ============
        const PATHS = { groups: 'sunday/groups' };

        async function saveBoardData() {
            if (!firebaseReady) return;
            try {
                await database.ref(`${PATHS.groups}/main`).set(data.groups);
                showToast('تم الحفظ');
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        async function loadBoardData() {
            if (!firebaseReady) return false;
            try {
                const snap = await database.ref(`${PATHS.groups}/main`).once('value');
                const groups = snap.val();
                if (groups) {
                    data.groups = Array.isArray(groups) ? groups : Object.values(groups);
                    return true;
                }
            } catch (e) {
                console.error('Load error:', e);
            }
            return false;
        }

        let saveTimer;
        function autoSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(saveBoardData, 1000);
        }

        // ============ UI HELPERS ============
        function showLoading(text) {
            document.querySelector('.loading-text').textContent = text || 'جاري التحميل...';
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            document.getElementById('toastText').textContent = text;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ============ INIT ============
        async function init() {
            initFirebase();
            const loaded = await loadBoardData();
            hideLoading();
            renderBoard();
            setLang('ar');
            if (!loaded) setTimeout(saveBoardData, 2000);
        }

        init();
    </script>
</body>
</html>
